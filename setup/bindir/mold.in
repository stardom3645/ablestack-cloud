#!/usr/bin/env bash

oper=$1

if [ -z "$oper" ]
then
    echo "인자값 입력해 주세요(start, stop)"
    exit 0
elif [ "$oper" == "start" ]
then
    # kek 생성시 필요한 비밀번호 입력
    echo "::::: 키 암호화 키(KEK) 생성시 필요한 비밀번호를 입력해주세요.(4자 이상) :::::"

    while :
    do
        echo -n "비밀번호 : "
        read -s kek_pass
        echo " "

        echo -n "비밀번호 확인 : "
        read -s kek_pass_check
        echo " "

        if [ "$kek_pass" != "$kek_pass_check" ] || [ -z $kek_pass ] || [ ${#kek_pass} -lt 4 ]
        then
            echo "비밀번호를 다시 확인해주세요.(4자 이상)"
        else
            break
        fi
    done

    cd /etc/cloudstack/management

    # kek 생성
    kek=$(openssl kdf -keylen 16 -kdfopt digest:SHA2-256 -kdfopt pass:$kek_pass -kdfopt salt:$(cat kek.salt) -kdfopt iter:100000 PBKDF2 | base64)
    echo $kek >> kek
    # echo "kek >> "$kek


    /usr/bin/systemctl start cloudstack-management
else
    /usr/bin/systemctl stop cloudstack-management
fi